version: "3.7"

services:
  dex:
    # https://github.com/dexidp/dex/releases
    image: dexidp/dex:v2.41.1
    network_mode: host
    volumes:
      - ./dex-config.yml:/etc/dex/config.yml
    command: ["dex", "serve", "/etc/dex/config.yml"]
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5556/healthz"]
      interval: 2s
      timeout: 5s
      retries: 10
      start_period: 2s

  oauth2-proxy:
    # https://github.com/oauth2-proxy/oauth2-proxy/releases
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.8.1
    network_mode: host
    environment:
      - OAUTH2_PROXY_PROVIDER=oidc
      - OAUTH2_PROXY_CLIENT_ID=example-app
      - OAUTH2_PROXY_CLIENT_SECRET=example-app-secret
      - OAUTH2_PROXY_COOKIE_SECRET=cookie-secret-replace-me
      - OAUTH2_PROXY_OIDC_ISSUER_URL=http://localhost:5556
      - OAUTH2_PROXY_INSECURE_OIDC_SKIP_ISSUER_VERIFICATION=true
      - OAUTH2_PROXY_PROVIDER_DISPLAY_NAME=Dex
      - OAUTH2_PROXY_REDIRECT_URL=http://localhost:4180/oauth2/callback
      - OAUTH2_PROXY_UPSTREAMS=http://localhost:3000/#/,http://localhost:3130/api/#/api/
      - OAUTH2_PROXY_EMAIL_DOMAINS=*
      - OAUTH2_PROXY_COOKIE_SECURE=false
      - OAUTH2_PROXY_HTTP_ADDRESS=0.0.0.0:4180
      - OAUTH2_PROXY_COOKIE_DOMAINS=.localhost
      - OAUTH2_PROXY_WHITELIST_DOMAINS=.localhost:4180,.localhost:3000,.localhost:3130
      - OAUTH2_PROXY_COOKIE_NAME=_oauth2_proxy
      - OAUTH2_PROXY_SET_XAUTHREQUEST=true
      - OAUTH2_PROXY_PASS_AUTHORIZATION_HEADER=true
    depends_on:
      dex:
        condition: service_healthy

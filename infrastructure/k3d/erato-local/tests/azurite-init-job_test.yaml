suite: test azurite init job
templates:
  - azurite-init-job.yaml
tests:
  - it: should render job with correct configuration
    asserts:
      - isKind:
          of: Job
      - equal:
          path: metadata.name
          value: RELEASE-NAME-erato-local-azurite-init
      - equal:
          path: metadata.annotations["helm.sh/hook"]
          value: post-install,post-upgrade
      - equal:
          path: metadata.annotations["helm.sh/hook-weight"]
          value: "1"
      - equal:
          path: metadata.annotations["helm.sh/hook-delete-policy"]
          value: hook-succeeded

  - it: should have correct restart policy
    asserts:
      - equal:
          path: spec.template.spec.restartPolicy
          value: OnFailure

  - it: should have wait-for-azurite init container
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: wait-for-azurite
      - equal:
          path: spec.template.spec.initContainers[0].image
          value: busybox:1.36
      - contains:
          path: spec.template.spec.initContainers[0].command
          content: sh

  - it: should have create-container with azure-cli
    asserts:
      - equal:
          path: spec.template.spec.containers[0].name
          value: create-container
      - equal:
          path: spec.template.spec.containers[0].image
          value: mcr.microsoft.com/azure-cli:2.61.0
      - contains:
          path: spec.template.spec.containers[0].command
          content: /bin/sh

  - it: should include proper labels
    asserts:
      - isNotEmpty:
          path: metadata.labels
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: erato-local
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  - it: should have container creation command
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].args[0]
          pattern: 'az storage container create'
      - matchRegex:
          path: spec.template.spec.containers[0].args[0]
          pattern: 'erato-storage'

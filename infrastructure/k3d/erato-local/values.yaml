# File storage configuration
# This will be mounted as erato.file-storage.auto.erato.toml
fileStorageConfig:
  enabled: true
  # sourceFile: Path to file relative to chart root (e.g., "config/erato.file-storage.toml")
  # If not specified, defaults to "config/erato.file-storage.toml"
  sourceFile: ""

# Test scenario configuration
# This will be mounted as erato.scenario.auto.erato.toml
testScenarioConfig:
  enabled: true
  # sourceFile: Path to file relative to chart root (e.g., "config/erato.scenario-basic.toml")
  # If not specified, defaults to "config/erato.scenario-basic.toml"
  sourceFile: ""

# E2E secrets configuration
# Generated scenario-specific secret files are mounted as erato.scenario.auto.erato.toml
# These are created by running: ../../scripts/setup-e2e-secrets apply
scenarioSecretsConfig:
  enabled: false  # Enabled automatically by setup-dev when .auto.toml files exist
  scenario: "basic"  # Which scenario secret to mount (basic, tight-budget, assistants, many-models)

erato:
  commonAnnotations:
    reloader.stakater.com/auto: "true"

  ingress:
    enabled: true
    host: app.erato.internal
    className: nginx
    annotations:
      nginx.ingress.kubernetes.io/proxy-buffer-size: 8k
      nginx.ingress.kubernetes.io/proxy-buffers-number: '4'
      nginx.ingress.kubernetes.io/proxy-body-size: 0

  backend:
    image:
      repository: harbor.imassage.me/erato/app
      tag: "adff59a50e3b78d0221a8a5bbb818a249fffb45a"
      pullPolicy: Always
    configFile:
      secretName: erato-local-erato-toml-secret
      secretKey: erato.toml
    extraConfigFiles:
      - name: file-storage
        configMapName: erato-local-erato-file-storage-config
        configMapKey: erato.file-storage.toml
      - name: test-scenario
        configMapName: erato-local-erato-test-scenario-config
        configMapKey: erato.scenario.toml
      - name: frontend-env
        inlineContent: |
          [frontend.additional_environment]
          FOO_BAR = "true"

  oauth2Proxy:
    enabled: true
    config: |
      http_address = "0.0.0.0:4180"

      # Hostname of the app. Structure <release_name>-erato-app
      upstreams = ["http://erato-local-erato-app:3130"]
      scope="openid profile email offline_access"
      email_domains = ["*"]
      cookie_secret = "0123456789abcdef0123456789abcdef"  # Replace in production
      cookie_secure = false
      provider = "oidc"
      client_id = "erato-app"
      client_secret = "ZXJhdG8tc2VjcmV0"  # Replace in production
      skip_oidc_discovery = true
      oidc_issuer_url = "http://erato-local-dex.erato-local-ns.svc.cluster.local:5556"
      login_url = "http://dex.erato.internal/auth"
      redeem_url = "http://erato-local-dex.erato-local-ns.svc.cluster.local:5556/token"
      oidc_jwks_url = "http://erato-local-dex.erato-local-ns.svc.cluster.local:5556/keys"
      redirect_url = "https://app.erato.internal/oauth2/callback"
      skip_auth_regex = ["^/health", "^/metrics"]
      pass_authorization_header = true
      pass_access_token = true
      pass_user_headers = true

      cookie_refresh = "30m"

      insecure_oidc_skip_issuer_verification = true
    
    redis:
      persistence:
        enabled: false

  postgresql:
    enabled: false
    external:
      connectionString:
        valueFrom:
          secretKeyRef:
            # This will be created by the postgres-cluster.yaml template
            name: erato-local-postgres-app
            key: uri

mockLlmServer:
  enabled: true
  image:
    repository: harbor.imassage.me/erato/mock-llm-server
    tag: "adff59a50e3b78d0221a8a5bbb818a249fffb45a"
    pullPolicy: Always
  service:
    type: ClusterIP
    port: 44320
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 250m
      memory: 256Mi

dex:
  enabled: true
  image:
    repository: dexidp/dex
    tag: v2.41.1
    pullPolicy: IfNotPresent
  
  ingress:
    enabled: true
    host: dex.erato.internal
    className: nginx
  
  config: |
    issuer: http://dex.erato.internal
    storage:
      type: memory
    oauth2:
      skipApprovalScreen: true
    web:
      http: 0.0.0.0:5556
    staticClients:
    - id: erato-app
      redirectURIs:
      - 'https://app.erato.internal/oauth2/callback'
      name: 'Erato App'
      secret: ZXJhdG8tc2VjcmV0
    enablePasswordDB: true
    staticPasswords:
    - email: "admin@example.com"
      hash: "$2y$10$EI3YbB3STkWvAzAyZ/fU/ehRT6M5ActxvZS9rZ1fXmTV2zxYNgUaK" # password: admin
      username: "admin"
      userID: "08a8684b-db88-4b73-90a9-3cd1661f5466"
    
    - email: "user01@example.com"
      hash: "$2y$10$EI3YbB3STkWvAzAyZ/fU/ehRT6M5ActxvZS9rZ1fXmTV2zxYNgUaK" # password: admin
      username: "user"
      userID: "08a8684b-db88-4b73-90a9-3cd166100001"

    - email: "user02@example.com"
      hash: "$2y$10$EI3YbB3STkWvAzAyZ/fU/ehRT6M5ActxvZS9rZ1fXmTV2zxYNgUaK" # password: admin
      username: "user"
      userID: "08a8684b-db88-4b73-90a9-3cd166100002"

    - email: "user03@example.com"
      hash: "$2y$10$EI3YbB3STkWvAzAyZ/fU/ehRT6M5ActxvZS9rZ1fXmTV2zxYNgUaK" # password: admin
      username: "user"
      userID: "08a8684b-db88-4b73-90a9-3cd166100003"

    - email: "user04@example.com"
      hash: "$2y$10$EI3YbB3STkWvAzAyZ/fU/ehRT6M5ActxvZS9rZ1fXmTV2zxYNgUaK" # password: admin
      username: "user"
      userID: "08a8684b-db88-4b73-90a9-3cd166100004"

    - email: "user05@example.com"
      hash: "$2y$10$EI3YbB3STkWvAzAyZ/fU/ehRT6M5ActxvZS9rZ1fXmTV2zxYNgUaK" # password: admin
      username: "user"
      userID: "08a8684b-db88-4b73-90a9-3cd166100005"

    - email: "user06@example.com"
      hash: "$2y$10$EI3YbB3STkWvAzAyZ/fU/ehRT6M5ActxvZS9rZ1fXmTV2zxYNgUaK" # password: admin
      username: "user"
      userID: "08a8684b-db88-4b73-90a9-3cd166100006"

# Nginx-based authentication (alternative to oauth2-proxy/Dex)
# When enabled, replaces oauth2-proxy with JWT generation from URL parameters/headers
nginxAuth:
  enabled: false  # Set to true for nginx-auth scenario
  replicas: 1
  image:
    repository: nginx
    tag: "1.25-alpine"
    pullPolicy: IfNotPresent
    pullSecrets: []

  # JWT configuration
  jwtSecret: "erato-nginx-jwt-secret-key-change-in-production"
  jwtExpirationSeconds: 3600  # 1 hour
  jwtIssuer: "nginx-jwt-generator"
  jwtAudience: "erato"

  # Cookie configuration
  cookieName: "erato-auth-user"
  cookieSameSite: "None"  # "None" for iframe compatibility, "Lax" for same-site only

  service:
    type: ClusterIP
    port: 80

  ingress:
    enabled: true
    host: app.erato.internal
    className: nginx
    annotations: {}
    tls:
      enabled: false
      secretName: ""

  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi

  # Embedded host configuration - serves a test page with iframe
  embeddedHost:
    enabled: true
    replicas: 1
    image:
      repository: nginx
      tag: "1.25-alpine"
      pullPolicy: IfNotPresent

    service:
      type: ClusterIP
      port: 80

    ingress:
      enabled: true
      host: embedded-host.erato.internal
      className: nginx
      annotations: {}
      tls:
        enabled: false
        secretName: ""

    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 100m
        memory: 128Mi

  extraEnv: []

# Main chart values
postgresql:
  enabled: true
  instances: 1
  image:
    repository: ghcr.io/cloudnative-pg/postgresql
    tag: "17.2"
  storage:
    size: 2Gi

seaweedfs:
  enabled: false
  master:
    replicas: 1
    raftHashicorp: true
    heartbeatInterval: "100ms"
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
    data:
      type: "emptyDir"  # Ephemeral storage for fast startup
  
  volume:
    replicas: 1
    resources:
      requests:
        memory: "128Mi"
        cpu: "50m"
    data:
      type: "emptyDir"  # Ephemeral storage for fast startup
  
  filer:
    enabled: true
    replicas: 1
  
  s3:
    enabled: true
    replicas: 1
    port: 8333

seaweedMini:
  enabled: true
  image:
    repository: chrislusf/seaweedfs
    tag: "4.08"
    pullPolicy: IfNotPresent
  serviceName: seaweedfs-s3
  ports:
    master: 9333
    masterGrpc: 9340
    filer: 8888
    s3: 8333
    filerGrpc: 7333
    volumeGrpc: 23646
  storage:
    type: emptyDir
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

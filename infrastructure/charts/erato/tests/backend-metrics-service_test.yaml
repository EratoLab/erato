# yaml-language-server: $schema=../tests_schema/helm-testsuite.json
suite: test backend metrics service
minimumVersion: 1.0.1
templates:
  - backend-metrics-service.yaml
tests:
  - it: should not render by default
    asserts:
      - hasDocuments:
          count: 0

  - it: should not render when metrics integration is enabled but service is disabled
    set:
      backend.metrics.enabled: true
      backend.metrics.service.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should render metrics service when enabled
    set:
      backend.metrics.enabled: true
      backend.metrics.service.enabled: true
      backend.metrics.service.port: 3131
    asserts:
      - isKind:
          of: Service
      - equal:
          path: metadata.name
          value: RELEASE-NAME-backend-metrics
      - equal:
          path: metadata.namespace
          value: NAMESPACE
      - equal:
          path: spec.type
          value: ClusterIP
      - equal:
          path: spec.ports[0].name
          value: metrics
      - equal:
          path: spec.ports[0].port
          value: 3131
      - equal:
          path: spec.ports[0].targetPort
          value: metrics
      - equal:
          path: metadata.annotations["prometheus.io/scrape"]
          value: "true"
      - equal:
          path: metadata.annotations["prometheus.io/path"]
          value: /metrics
      - equal:
          path: metadata.annotations["prometheus.io/port"]
          value: "3131"
      - equal:
          path: spec.selector["app.kubernetes.io/component"]
          value: erato-app

  - it: should allow disabling default scrape annotations
    set:
      backend.metrics.enabled: true
      backend.metrics.service.enabled: true
      backend.metrics.service.addPrometheusAnnotations: false
    asserts:
      - notExists:
          path: metadata.annotations["prometheus.io/scrape"]

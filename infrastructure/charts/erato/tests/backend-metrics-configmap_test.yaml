# yaml-language-server: $schema=../tests_schema/helm-testsuite.json
suite: test backend metrics configmap
minimumVersion: 1.0.1
templates:
  - backend-metrics-configmap.yaml
tests:
  - it: should not render by default
    asserts:
      - hasDocuments:
          count: 0

  - it: should not render when metrics is enabled but config file rendering is disabled
    set:
      backend.metrics.enabled: true
      backend.metrics.configFile.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should render metrics auto config when enabled
    set:
      backend.metrics.enabled: true
      backend.metrics.configFile.enabled: true
      backend.metrics.host: 0.0.0.0
      backend.metrics.port: 3131
    asserts:
      - isKind:
          of: ConfigMap
      - equal:
          path: metadata.name
          value: RELEASE-NAME-backend-metrics-config
      - equal:
          path: metadata.namespace
          value: NAMESPACE
      - equal:
          path: data["metrics.auto.erato.toml"]
          value: |
            [integrations.prometheus]
            enabled = true
            host = "0.0.0.0"
            port = 3131

# yaml-language-server: $schema=../tests_schema/helm-testsuite.json
suite: test ingress
minimumVersion: 1.0.1
templates:
  - ingress.yaml
tests:
  - it: should render ingress when enabled
    asserts:
      - isKind:
          of: Ingress
      - equal:
          path: metadata.name
          value: RELEASE-NAME-ingress
      - equal:
          path: spec.ingressClassName
          value: nginx
      - equal:
          path: spec.rules[0].host
          value: app.erato.internal
      - equal:
          path: spec.rules[0].http.paths[0].path
          value: /
      - equal:
          path: spec.rules[0].http.paths[0].pathType
          value: Prefix

  - it: should not render when ingress is disabled
    set:
      ingress.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should use custom host and className
    set:
      ingress.host: custom.example.com
      ingress.className: traefik
    asserts:
      - equal:
          path: spec.ingressClassName
          value: traefik
      - equal:
          path: spec.rules[0].host
          value: custom.example.com

  - it: should route to oauth2-proxy when enabled
    set:
      oauth2Proxy.enabled: true
    asserts:
      - equal:
          path: spec.rules[0].http.paths[0].backend.service.name
          value: RELEASE-NAME-oauth2-proxy

  - it: should route to backend when oauth2-proxy is disabled
    set:
      oauth2Proxy.enabled: false
    asserts:
      - equal:
          path: spec.rules[0].http.paths[0].backend.service.name
          value: RELEASE-NAME-backend

  - it: should include TLS when enabled
    set:
      ingress.tls.enabled: true
      ingress.tls.secretName: erato-tls
    asserts:
      - equal:
          path: spec.tls[0].hosts[0]
          value: app.erato.internal
      - equal:
          path: spec.tls[0].secretName
          value: erato-tls

  - it: should not include TLS when disabled
    set:
      ingress.tls.enabled: false
    asserts:
      - isEmpty:
          path: spec.tls

  - it: should include custom annotations
    set:
      ingress.annotations:
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
        cert-manager.io/cluster-issuer: letsencrypt
    asserts:
      - equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/ssl-redirect"]
          value: "true"
      - equal:
          path: metadata.annotations["cert-manager.io/cluster-issuer"]
          value: letsencrypt

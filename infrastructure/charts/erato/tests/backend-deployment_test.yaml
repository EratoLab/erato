# yaml-language-server: $schema=../tests_schema/helm-testsuite.json
suite: test backend deployment
minimumVersion: 1.0.1
templates:
  - backend-deployment.yaml
chart:
  appVersion: 0.2.99
  version: 0.2.99
tests:
  - it: should render a deployment with default values
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-erato-app
      - equal:
          path: metadata.namespace
          value: NAMESPACE
      - equal:
          path: spec.replicas
          value: 1
      - equal:
          path: spec.selector.matchLabels["app.kubernetes.io/component"]
          value: erato-app
      - equal:
          path: spec.template.spec.containers[0].name
          value: erato-backend
      - equal:
          path: spec.template.spec.containers[0].image
          value: harbor.imassage.me/erato/app:0.2.99
      - equal:
          path: spec.template.spec.containers[0].ports[0].containerPort
          value: 3130

  - it: should honor namespaceOverride
    set:
      namespaceOverride: custom-namespace
    asserts:
      - equal:
          path: metadata.namespace
          value: custom-namespace

  - it: should set custom replica count
    set:
      backend.replicaCount: 3
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  - it: should set backend deployment strategy when configured
    set:
      backend.deploymentStrategy:
        type: RollingUpdate
        rollingUpdate:
          maxUnavailable: 0
          maxSurge: 1
    asserts:
      - equal:
          path: spec.strategy.type
          value: RollingUpdate
      - equal:
          path: spec.strategy.rollingUpdate.maxUnavailable
          value: 0
      - equal:
          path: spec.strategy.rollingUpdate.maxSurge
          value: 1

  - it: should use custom image repository and tag
    set:
      backend.image.repository: my-registry/erato
      backend.image.tag: v1.2.3
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: my-registry/erato:v1.2.3

  - it: should set environment variables correctly
    set:
      global.environment: staging
      backend.extraEnvVars:
        - name: CUSTOM_VAR
          value: test-value
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ENVIRONMENT
            value: staging
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: CUSTOM_VAR
            value: test-value

  - it: should add envFrom when extraEnvVarsCM is set
    set:
      backend.extraEnvVarsCM: erato-config-cm
    asserts:
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            configMapRef:
              name: erato-config-cm

  - it: should add envFrom when extraEnvVarsSecret is set
    set:
      backend.extraEnvVarsSecret: erato-secret
    asserts:
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            secretRef:
              name: erato-secret

  - it: should mount config file when configFile is set
    set:
      backend.configFile.secretName: erato-config
      backend.configFile.secretKey: erato.toml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: erato-config
            mountPath: /app/erato.toml
            subPath: erato.toml
            readOnly: true
      - contains:
          path: spec.template.spec.volumes
          content:
            name: erato-config
            secret:
              secretName: erato-config
              items:
                - key: erato.toml
                  path: erato.toml

  - it: should set resource limits and requests
    set:
      backend.resources:
        requests:
          cpu: 200m
          memory: 256Mi
        limits:
          cpu: 1000m
          memory: 1Gi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 200m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 256Mi
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 1000m
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 1Gi

  - it: should have init container for migrations
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: run-migrations
      - equal:
          path: spec.template.spec.initContainers[0].command[0]
          value: /bin/bash
      - contains:
          path: spec.template.spec.initContainers[0].args
          content: "-c"

  - it: should include liveness and readiness probes
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /health
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: http
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /health
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: http

  - it: should not expose metrics port or env vars by default
    asserts:
      - lengthEqual:
          path: spec.template.spec.containers[0].ports
          count: 1
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: ERATO__INTEGRATIONS__PROMETHEUS__ENABLED

  - it: should expose metrics port and mount metrics auto config when metrics is enabled
    set:
      backend.metrics.enabled: true
      backend.metrics.host: 0.0.0.0
      backend.metrics.port: 3131
    asserts:
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: metrics
            containerPort: 3131
            protocol: TCP
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: erato-metrics-config
            mountPath: /app/metrics.auto.erato.toml
            subPath: metrics.auto.erato.toml
            readOnly: true
      - contains:
          path: spec.template.spec.volumes
          content:
            name: erato-metrics-config
            configMap:
              name: RELEASE-NAME-backend-metrics-config
              items:
                - key: metrics.auto.erato.toml
                  path: metrics.auto.erato.toml

  - it: should support extraVolumes and extraVolumeMounts
    set:
      backend.extraVolumes:
        - name: test-volume
          emptyDir: {}
        - name: secret-volume
          secret:
            secretName: my-secret
      backend.extraVolumeMounts:
        - name: test-volume
          mountPath: /tmp/test
        - name: secret-volume
          mountPath: /etc/secrets
          readOnly: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: test-volume
            emptyDir: {}
      - contains:
          path: spec.template.spec.volumes
          content:
            name: secret-volume
            secret:
              secretName: my-secret
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: test-volume
            mountPath: /tmp/test
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: secret-volume
            mountPath: /etc/secrets
            readOnly: true

  - it: should support extraVolumeMounts without extraVolumes
    set:
      backend.extraVolumeMounts:
        - name: existing-volume
          mountPath: /mnt/existing
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: existing-volume
            mountPath: /mnt/existing

  - it: should support extraVolumes without extraVolumeMounts
    set:
      backend.extraVolumes:
        - name: unused-volume
          configMap:
            name: my-config
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: unused-volume
            configMap:
              name: my-config

  - it: should not include volumes or volumeMounts when none are configured
    set:
      backend.configFile.secretName: ""
      backend.configFile.secretKey: ""
      backend.extraVolumes: []
      backend.extraVolumeMounts: []
    asserts:
      - notExists:
          path: spec.template.spec.volumes
      - notExists:
          path: spec.template.spec.containers[0].volumeMounts

  - it: should work with both configFile and extraVolumes/extraVolumeMounts
    set:
      backend.configFile.secretName: "erato-config-secret"
      backend.configFile.secretKey: "erato.toml"
      backend.extraVolumes:
        - name: additional-volume
          emptyDir: {}
      backend.extraVolumeMounts:
        - name: additional-volume
          mountPath: /tmp/additional
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: erato-config
            secret:
              secretName: erato-config-secret
              items:
                - key: erato.toml
                  path: erato.toml
      - contains:
          path: spec.template.spec.volumes
          content:
            name: additional-volume
            emptyDir: {}
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: erato-config
            mountPath: /app/erato.toml
            subPath: erato.toml
            readOnly: true
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: additional-volume
            mountPath: /tmp/additional

  - it: should mount config file from configMap
    set:
      backend.configFile.configMapName: erato-config-cm
      backend.configFile.configMapKey: erato.toml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: erato-config
            mountPath: /app/erato.toml
            subPath: erato.toml
            readOnly: true
      - contains:
          path: spec.template.spec.volumes
          content:
            name: erato-config
            configMap:
              name: erato-config-cm
              items:
                - key: erato.toml
                  path: erato.toml

  - it: should mount config file from inline content
    set:
      backend.configFile.inlineContent: |
        [database]
        host = "localhost"
        port = 5432
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: erato-config
            mountPath: /app/erato.toml
            subPath: erato.toml
            readOnly: true
      - contains:
          path: spec.template.spec.volumes
          content:
            name: erato-config
            configMap:
              name: RELEASE-NAME-erato-inline-config
              items:
                - key: erato.toml
                  path: erato.toml

  - it: should mount extra config files from secrets
    set:
      backend.extraConfigFiles:
        - name: mcp-config
          secretName: mcp-secret
          secretKey: mcp.toml
        - name: additional-config
          secretName: additional-secret
          secretKey: additional.toml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: extra-config-mcp-config
            mountPath: /app/mcp-config.auto.erato.toml
            subPath: mcp-config.auto.erato.toml
            readOnly: true
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: extra-config-additional-config
            mountPath: /app/additional-config.auto.erato.toml
            subPath: additional-config.auto.erato.toml
            readOnly: true
      - contains:
          path: spec.template.spec.volumes
          content:
            name: extra-config-mcp-config
            secret:
              secretName: mcp-secret
              items:
                - key: mcp.toml
                  path: mcp-config.auto.erato.toml
      - contains:
          path: spec.template.spec.volumes
          content:
            name: extra-config-additional-config
            secret:
              secretName: additional-secret
              items:
                - key: additional.toml
                  path: additional-config.auto.erato.toml

  - it: should mount extra config files from configMaps
    set:
      backend.extraConfigFiles:
        - name: mcp-config
          configMapName: mcp-config-cm
          configMapKey: mcp.toml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: extra-config-mcp-config
            mountPath: /app/mcp-config.auto.erato.toml
            subPath: mcp-config.auto.erato.toml
            readOnly: true
      - contains:
          path: spec.template.spec.volumes
          content:
            name: extra-config-mcp-config
            configMap:
              name: mcp-config-cm
              items:
                - key: mcp.toml
                  path: mcp-config.auto.erato.toml

  - it: should mount extra config files from inline content
    set:
      backend.extraConfigFiles:
        - name: mcp-config
          inlineContent: |
            [mcp_servers.example]
            command = "example-server"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: extra-config-mcp-config
            mountPath: /app/mcp-config.auto.erato.toml
            subPath: mcp-config.auto.erato.toml
            readOnly: true
      - contains:
          path: spec.template.spec.volumes
          content:
            name: extra-config-mcp-config
            configMap:
              name: RELEASE-NAME-extra-config-mcp-config-inline
              items:
                - key: mcp-config.toml
                  path: mcp-config.auto.erato.toml

  - it: should handle mixed config file sources
    set:
      backend.configFile.inlineContent: |
        [database]
        host = "localhost"
      backend.extraConfigFiles:
        - name: mcp-config
          secretName: mcp-secret
          secretKey: mcp.toml
        - name: additional-config
          configMapName: additional-cm
          configMapKey: additional.toml
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: erato-config
            mountPath: /app/erato.toml
            subPath: erato.toml
            readOnly: true
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: extra-config-mcp-config
            mountPath: /app/mcp-config.auto.erato.toml
            subPath: mcp-config.auto.erato.toml
            readOnly: true
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: extra-config-additional-config
            mountPath: /app/additional-config.auto.erato.toml
            subPath: additional-config.auto.erato.toml
            readOnly: true

  # Annotation tests
  - it: should not include deployment annotations when none are set
    asserts:
      - notExists:
          path: metadata.annotations

  - it: should include deployment annotations when backend.deploymentAnnotations is set
    set:
      backend.deploymentAnnotations:
        deployment.kubernetes.io/revision: "1"
        custom/annotation: "value"
    asserts:
      - equal:
          path: metadata.annotations["deployment.kubernetes.io/revision"]
          value: "1"
      - equal:
          path: metadata.annotations["custom/annotation"]
          value: "value"

  - it: should include deployment annotations when commonAnnotations is set
    set:
      commonAnnotations:
        common/annotation: "common-value"
        environment: "test"
    asserts:
      - equal:
          path: metadata.annotations["common/annotation"]
          value: "common-value"
      - equal:
          path: metadata.annotations["environment"]
          value: "test"

  - it: should merge deployment annotations with commonAnnotations
    set:
      commonAnnotations:
        common/annotation: "common-value"
        environment: "test"
      backend.deploymentAnnotations:
        deployment.kubernetes.io/revision: "1"
        backend/specific: "backend-value"
    asserts:
      - equal:
          path: metadata.annotations["common/annotation"]
          value: "common-value"
      - equal:
          path: metadata.annotations["environment"]
          value: "test"
      - equal:
          path: metadata.annotations["deployment.kubernetes.io/revision"]
          value: "1"
      - equal:
          path: metadata.annotations["backend/specific"]
          value: "backend-value"

  - it: should override commonAnnotations with backend.deploymentAnnotations when keys conflict
    set:
      commonAnnotations:
        environment: "common-environment"
        common/annotation: "common-value"
      backend.deploymentAnnotations:
        environment: "backend-environment"
        backend/specific: "backend-value"
    asserts:
      - equal:
          path: metadata.annotations["environment"]
          value: "backend-environment"
      - equal:
          path: metadata.annotations["common/annotation"]
          value: "common-value"
      - equal:
          path: metadata.annotations["backend/specific"]
          value: "backend-value"

  - it: should not include pod annotations when none are set
    asserts:
      - notExists:
          path: spec.template.metadata.annotations

  - it: should include pod annotations when backend.podAnnotations is set
    set:
      backend.podAnnotations:
        pod/annotation: "pod-value"
        prometheus.io/scrape: "true"
    asserts:
      - equal:
          path: spec.template.metadata.annotations["pod/annotation"]
          value: "pod-value"
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/scrape"]
          value: "true"

  - it: should include pod annotations when commonAnnotations is set
    set:
      commonAnnotations:
        common/annotation: "common-value"
        prometheus.io/port: "8080"
    asserts:
      - equal:
          path: spec.template.metadata.annotations["common/annotation"]
          value: "common-value"
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/port"]
          value: "8080"

  - it: should merge pod annotations with commonAnnotations
    set:
      commonAnnotations:
        common/annotation: "common-value"
        prometheus.io/port: "8080"
      backend.podAnnotations:
        pod/annotation: "pod-value"
        prometheus.io/scrape: "true"
    asserts:
      - equal:
          path: spec.template.metadata.annotations["common/annotation"]
          value: "common-value"
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/port"]
          value: "8080"
      - equal:
          path: spec.template.metadata.annotations["pod/annotation"]
          value: "pod-value"
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/scrape"]
          value: "true"

  - it: should override commonAnnotations with backend.podAnnotations when keys conflict
    set:
      commonAnnotations:
        prometheus.io/scrape: "false"
        common/annotation: "common-value"
      backend.podAnnotations:
        prometheus.io/scrape: "true"
        pod/specific: "pod-value"
    asserts:
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/scrape"]
          value: "true"
      - equal:
          path: spec.template.metadata.annotations["common/annotation"]
          value: "common-value"
      - equal:
          path: spec.template.metadata.annotations["pod/specific"]
          value: "pod-value"

  - it: should render annotations with template values
    set:
      backend.deploymentAnnotations:
        app.version: "{{ .Chart.AppVersion }}"
        release.name: "{{ .Release.Name }}"
      backend.podAnnotations:
        chart.version: "{{ .Chart.Version }}"
        namespace: "{{ .Release.Namespace }}"
    asserts:
      - equal:
          path: metadata.annotations["app.version"]
          value: "0.2.99"
      - equal:
          path: metadata.annotations["release.name"]
          value: "RELEASE-NAME"
      - equal:
          path: spec.template.metadata.annotations["chart.version"]
          value: "0.2.99"
      - equal:
          path: spec.template.metadata.annotations["namespace"]
          value: "NAMESPACE"
